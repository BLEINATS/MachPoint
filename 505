/*
  # [Fix] Corrigir referência à coluna 'clientName' no gatilho de notificação de reserva

  Este patch corrige um erro de digitação em uma função de gatilho (`trigger`) 
  que é executada sempre que uma nova reserva é criada.

  ## Descrição da Query:
  A função `handle_new_reservation_notification` estava tentando acessar a coluna `clientname` 
  (tudo em minúsculas) em vez de `"clientName"` (com aspas, respeitando o case). 
  Isso causava um erro que impedia o salvamento de novas reservas.

  Esta migração:
  1. Remove a função antiga e com defeito.
  2. Recria a mesma função com a referência correta à coluna (`NEW."clientName"`).
  
  Esta operação é segura e não afeta dados existentes, apenas corrige o comportamento 
  para futuras inserções de reservas.

  ## Metadados:
  - Categoria do Esquema: "Estrutural"
  - Nível de Impacto: "Baixo"
  - Requer Backup: false
  - Reversível: true (recriando a versão antiga da função)

  ## Detalhes da Estrutura:
  - Objeto afetado: Função `handle_new_reservation_notification()`
  - Tipo de objeto: `FUNCTION`

  ## Implicações de Segurança:
  - Status de RLS: Sem alterações
  - Mudanças de Política: Não
  - Requisitos de Autenticação: A função é executada com os privilégios do definidor (`SECURITY DEFINER`), o que é comum para gatilhos que precisam inserir em tabelas como `notificacoes`.

  ## Impacto no Desempenho:
  - Índices: Sem alterações
  - Gatilhos: A função corrigida será executada pelo mesmo gatilho de antes.
  - Impacto Estimado: Nenhum impacto negativo. O desempenho será o mesmo da função original, mas sem o erro.
*/

-- Remove a função antiga se ela existir para evitar conflitos
DROP FUNCTION IF EXISTS public.handle_new_reservation_notification();

-- Recria a função com a correção
CREATE OR REPLACE FUNCTION public.handle_new_reservation_notification()
RETURNS TRIGGER AS $$
BEGIN
  -- Insere uma notificação para o administrador da arena
  INSERT INTO public.notificacoes (arena_id, message, type, link_to)
  VALUES (
    NEW.arena_id,
    'Nova reserva de ' || NEW."clientName" || ' para ' || to_char(NEW.date, 'DD/MM') || ' às ' || NEW.start_time,
    'nova_reserva',
    '/reservas'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Garante que o gatilho está configurado corretamente (opcional, mas bom para garantir)
-- Primeiro, remove o gatilho antigo para evitar duplicatas
DROP TRIGGER IF EXISTS on_new_reservation_notification ON public.reservas;

-- Cria o gatilho para executar a função após cada nova reserva
CREATE TRIGGER on_new_reservation_notification
AFTER INSERT ON public.reservas
FOR EACH ROW
EXECUTE FUNCTION public.handle_new_reservation_notification();
